# 研发效能分析官 - 使用指南

## 🎯 当前能做什么

### 1. 数据分析能力 ✅
- 读取Gerrit代码审查数据（JSON格式）
- 计算关键指标：Review耗时、返工率、P95指标
- 检测异常：自动识别超过阈值的问题
- 项目维度分析：对比不同项目/团队效率

### 2. 报告生成能力 ✅
- 生成Markdown格式的效率报告
- 包含核心指标、异常发现、根因分析
- 提供分级建议（紧急/短期/长期）
- 生成可执行的行动项清单

### 3. 深度洞察能力 ✅
- 解释指标背后的业务含义
- 分析可能的根本原因
- 提供可操作的改进建议
- 量化预期效果

### 4. 文件操作能力 ✅
- 读取data/目录下的数据文件
- 写入reports/目录生成报告
- 执行Python分析脚本
- 统计文件大小和数量

---

## 🚀 如何触发

### 方式1: 通过Flutter前端（推荐）

1. 打开浏览器访问: http://localhost:60913
2. 登录账号
3. 选择"研发效能分析官"
4. 发送消息，例如：
   - "分析一下昨天的代码审查数据"
   - "生成本周的效率报告"
   - "为什么返工率这么高？"

### 方式2: 通过HTTP API

```bash
curl -X POST http://localhost:8000/api/v1/chat/stream \
  -H "Content-Type: application/json" \
  -d '{
    "agent_role": "dev_efficiency_analyst",
    "message": "请读取 data/mock_gerrit_data.json 并分析效率",
    "conversation_history": []
  }'
```

### 方式3: 通过Python脚本

```python
import requests
import json

url = "http://localhost:8000/api/v1/chat/stream"
payload = {
    "agent_role": "dev_efficiency_analyst",
    "message": "分析代码审查效率",
    "conversation_history": []
}

response = requests.post(url, json=payload, stream=True)
for line in response.iter_lines():
    if line:
        decoded = line.decode('utf-8')
        if decoded.startswith('data:'):
            data_part = decoded[5:].strip()
            if data_part and data_part != '{}':
                data = json.loads(data_part)
                if 'content' in data:
                    print(data['content'], end='', flush=True)
```

---

## 📝 示例对话

### 示例1: 数据分析
```
用户: "读取 data/mock_gerrit_data.json 并分析代码审查效率"

AI: [自动执行]
  1. 读取JSON文件
  2. 执行gerrit_analysis.py分析
  3. 返回:
     - Review中位耗时: 49小时（超标）
     - 返工率: 67%（严重超标）
     - 3个异常发现
     - 6条改进建议
```

### 示例2: 报告生成
```
用户: "生成一份详细的效率报告保存到reports目录"

AI: [自动执行]
  1. 分析数据
  2. 生成Markdown报告
  3. 保存到 reports/efficiency_report.md
  4. 返回报告摘要
```

### 示例3: 深度咨询
```
用户: "如果Review耗时50小时，返工率70%，意味着什么？"

AI: [自动分析]
  返回:
  - 问题严重程度（超标2-4倍）
  - 业务影响（效率损失70%）
  - 可能原因（5个方向）
  - 改进建议（分优先级）
  - 预期效果（定量）
```

---

## 🔧 当前技术实现

### 架构
```
Flutter前端
    ↓
FastAPI后端 (http://localhost:8000)
    ↓
AgentManager (agent_manager.py)
    ↓
Anthropic Python SDK → Claude API
    ↓
工具执行: bash, read_file, write_file, web_fetch
```

### 不是真正的Claude Code CLI
**实际情况**:
- ❌ 没有使用 `@anthropic-ai/claude-code` npm包
- ✅ 使用Anthropic Python SDK（anthropic==0.75.0）
- ✅ 自己实现了工具执行层
- ✅ 模仿了Claude Code的架构模式

**为什么这样做？**
- Python更适合数据分析场景
- 更灵活（可自定义工具）
- 不依赖Node.js环境
- 但功能完全一致（都是调用Claude API + tool calling）

---

## 📊 已验证的能力

| 能力 | 状态 | 说明 |
|------|------|------|
| 读取JSON数据 | ✅ | 可读取data/目录文件 |
| 执行Python脚本 | ✅ | 可运行gerrit_analysis.py |
| 异常检测 | ✅ | 自动识别超过阈值的指标 |
| 生成Markdown报告 | ✅ | 保存到reports/目录 |
| 深度分析 | ✅ | 提供根因和建议 |
| 多轮对话 | ✅ | 支持上下文记忆 |
| 流式输出 | ✅ | SSE实时返回结果 |

---

## 🚧 待完善功能

### 数据源
- [ ] 真实Gerrit API集成（需要API权限）
- [ ] Jira/Issue系统集成
- [ ] 支持多种数据格式（CSV、Excel）

### 定时任务
- [ ] 每日自动分析（Celery）
- [ ] 异常自动提醒（Push通知）
- [ ] 趋势对比（环比、同比）

### 可视化
- [ ] 生成图表（趋势图、柱状图）
- [ ] PDF报告导出
- [ ] 交互式Dashboard

---

## 💡 下一步建议

### Option 1: 完善当前实现
- 接入真实Gerrit API
- 添加定时分析任务
- 实现图表生成
- 添加Push通知

### Option 2: 改用真正的Claude Code CLI
- 需要重构后端（调用Node.js CLI）
- 可能获得更多高级特性
- 但不确定是否适合我们的场景

### Option 3: 创建其他AI员工
- NPS洞察官
- 产品需求提炼官
- 竞品追踪分析官
- 知识管理官

---

**你倾向于哪个方向？**
